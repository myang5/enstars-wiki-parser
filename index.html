<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">

<html>

<head> <!--Code to be executed before page is displayed/rendered!-->
    <meta name="keywords" content="enstars, ensemble stars, ensemble stars wiki">
    <meta name="description" content="A text formatter for more efficiently uploading event/gacha stories to the Ensemble Stars Wiki.">
    <title>Story Formatter</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css?family=Jura:600" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">

</head>

<body> <!--Code to be displayed/rendered!-->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <!---HEADER!--->
    <header>
        <h1><a href="index.html">☆ENSTARS STORY FORMATTER☆</a></h1>
        <p>A website to more easily upload event/gacha stories from the mobile idol game
            Ensemble Stars to the fandom wiki.<br>It takes translated story dialogue
            and formats it into text that you can paste directly into the "source" section of the page.
        <br> Developed by gayandasleep@twitter.</p>
            <ul id="navbar">
                <li><a target="_blank" href="/">HOW TO USE</a></li>
                <li><a href="https://goo.gl/forms/Xu42LLAgWKxVYV873" target="_blank">QUESTIONS/FEEDBACK</a></li>
                <li><a href="./plans.html">DESIGN PLANS</a></li>
            </ul>
        </header>

        <!---TABS ON TOP OF INPUT!--->
        <div class="tab">
            <button class="tablink" onclick="openTab(this, 'inputArea')" id="defaultOpen">Text</button>
            <button class="tablink" onclick="openTab(this, 'detailArea')">Details</button>
            <button class="tablink" onclick="openTab(this, 'renderArea')">Renders</button>
            <button class="tablink" onclick="openTab(this, 'tlArea')">TL Notes</button>
        </div>

        <!---CONTENTS OF TABS!--->
        <script src='spectrum.js'></script>
        <link rel='stylesheet' href='spectrum.css' />
        <form id="everything">
            <!---INPUT TAB!--->
            <textarea id="inputArea" class="tabcontent" name="input"></textarea>
            <!---DETAILS TAB!--->
            <div id="detailArea" class="tabcontent">
                <label>Story Location</label>
                <input type="text" name="location"><br>
                <label>Story Writer</label>
                <select name="author">
                    <option value="akira">日日日 (Akira)</option>
                    <option value="yuuki">結城由乃 (Yuuki Yoshino)</option>
                </select><br>
                <label>Translator</label>
                <input type="text" name="translator"><br>
                <input type="radio" name="tlLocation" value="wiki" checked> Translator is wiki user<br>
                <input type="radio" name="tlLocation" value="external"> External link for credit needed
                <input type="text" name="tlLink"><br>
                <br>
                <label>Writer Label BG</label>
                <input class="jscolor" name="writerCol" value="fff"><br>
                <label>Location Label BG</label>
                <input class="jscolor" name="locationCol" value="fff"><br>
                <label>Bottom Label BG</label>
                <input class="jscolor" name="bottomCol" value="fff"><br>
                <label>Text Label BG</label>
                <input class="jscolor" name="textCol" value="fff"><br>
            </div>
            <!---RENDERTAB!--->
            <div id="renderArea" class="tabcontent">
                <p>Please paste in the filename as written in the wiki (including extension)
                of the dialogue render you want to use for each character. <br>
                (Forms will appear when you paste dialogue into the Text tab)</p>
                <label>Find renders for:</label>
				<select id="linkToRenders"></select>
				<button id="renderLinkBtn" onclick="openLink()" type="button">GO</button>
				<label id="linkErrMsg">Chara doesn't exist</label>
				<p></p>
                <div id="renderForms"></div>
            </div>
            <!---TLNOTETAB!--->
            <textarea id="tlArea" class="tabcontent" name="tl"></textarea>
            <button type="button" onclick="convertText()" id="convert">CONVERT</button>

        </form>

        <textarea id="outputArea"></textarea>

        <footer></footer>

        <script>
        $(".jscolor").spectrum({
            flat: false,
            showInput: true,
            className: "full-spectrum",
            showInitial: true,
            preferredFormat: "hex",

        });

        console.log($('#inputArea').height());

        </script>


        <script>
        
        $('#linkErrMsg').hide();
        		
        var placeholder = "Example of dialogue format:\n(what's important is that each line of dialogue has a name + \":\" and is on a new line)\n\nRitsu: Ah, I feel like Maa-kun’s thinking about me.\n\nRitsu: Well, he’s probably thinking about me all the time, anyway. Just like how I think about Maa-kun all the time too.\n\nRitsu: Yes, this is love… No matter when or where, Maa-kun and I are bonded by it.\n\nArashi: Mmhmm, I think so too~ That’s love right there.\n\nArashi: I’m so jealous~ You have such a wonderful romance…";
        $('#inputArea').attr('placeholder', placeholder);

        var placeholder1 = 'Paste the numbered translation notes (separated by line breaks) into here.';
        $('#tlArea').attr('placeholder', placeholder1);

        $('input[name=tlLink]').hide();

        function openTab(btn, tabName) {
            $('.tabcontent').hide();
            $('.tablink').removeClass("active");
            var tabId = "#" + tabName;
            $(tabId).css('display', "block");
            $(btn).addClass("active");
        }
        $('#defaultOpen').click();

        $('input[name=tlLocation]').change(function(){
            if($('input[name=tlLocation]:checked').val()=='wiki'){
                $('input[name=tlLink]').hide();
            }
            else if($('input[name=tlLocation]:checked').val()=='external'){
                $('input[name=tlLink]').show();
            }
        });
		
		//Updating Renders tab based on dialogue input
        var namesSet = new Set();
        $('#inputArea').change(function(){
            var input=$('#inputArea').val();
            input = input.split(/\n/);
            console.log(input);
            var names = [];
            input.forEach(function(exp){
            	if(exp != ""){
                	names.push(exp.slice(0,exp.indexOf(":")));
                }
            });
            names = new Set(names);
            
            //deletes divs that no longer exist in the new dialogue
            //deletes option from the link menu
            namesSet.forEach(function(exp){
                if(!names.has(exp)){
                    namesSet.delete(exp);
                    var cls = "." + exp;
                    $(cls).remove();
                    exp = exp[0].toUpperCase() + exp.slice(1,exp.length);
                    $('option:contains(' + exp + ')').remove();
                }
            });

            names.forEach(function(exp){
            	//format name slightly
            	exp = exp[0].toUpperCase() + exp.slice(1,exp.length);
            	//keeps the previously existing divs so that renders don't have to be re-entered
                if(!namesSet.has(exp)){ 
                    namesSet.add(exp);
                    //make input box for the render labeled w/ a name
                    var newDiv = $("<div></div>").addClass(exp);
                    var newLabel = $("<label></label>").text(exp);
                    var newInput = $("<input>").attr("id",exp);
                    $(newDiv).append(newLabel);
                    $(newDiv).append(newInput);
                    $('#renderForms').append(newDiv);
                    //add name option to dropdown menu of render page links
                    var sel = document.getElementById("linkToRenders");
                    var opt = document.createElement("option");
                    opt.text = exp;
                    sel.add(opt);
                }
            });
        });
        
        function openLink(){
        	var namesList = ['Tetora_Nagumo',
							'Hajime_Shino',
							'Tomoya_Mashiro',
							'Hinata_Aoi',
							'Midori_Takamine',
							'Tori_Himemiya',
							'Shinobu_Sengoku',
							'Mitsuru_Tenma',
							'Yuta_Aoi',
							'Tsukasa_Suou',
							'Sora_Harukawa',
							'Subaru_Akehoshi',
							'Hokuto_Hidaka',
							'Makoto_Yuuki',
							'Souma_Kanzaki',
							'Adonis_Otogari',
							'Natsume_Sakasaki',
							'Koga_Oogami',
							'Ritsu_Sakuma',
							'Mao_Isara',
							'Yuzuru_Fushimi',
							'Arashi_Narukami',
							'Mika_Kagehira',
							'Eichi_Tenshouin',
							'Keito_Hasumi',
							'Kaoru_Hakaze',
							'Izumi_Sena',
							'Chiaki_Morisawa',
							'Shu_Itsuki',
							'Madara_Mikejima',
							'Kuro_Kiryu',
							'Wataru_Hibiki',
							'Kanata_Shinkai',
							'Rei_Sakuma',
							'Nazuna_Nito',
							'Leo_Tsukinaga',
							'Tsumugi_Aoba',
							'Jin_Sagami',
							'Akiomi_Kunugi',
							'Hiyori_Tomoe',
							'Jun_Sazanami',
							'Nagisa_Ran',
							'Ibara_Saegusa'
				];
        	var name = $("#linkToRenders option:selected").text();
        	for(i = 0; i < namesList.length; i++) {
        		if(namesList[i].split('_')[0] == name){
        			$('#linkErrMsg').hide();
        			var url = "http://ensemble-stars.wikia.com/wiki/NAME/Gallery#Renders".replace("NAME", namesList[i]);
        			window.open(url, "_blank");
        			return;
        		}
        	}
        	$('#linkErrMsg').show();	
        }

    	function convertText(){
            var header =
            "{| class=\"article-table\" cellspacing=\"1/6\" cellpadding=\"2\" border=\"1\" align=\"center\" width=\"100%\"" + "\n" +
            "! colspan=\"2\" style=\"text-align:center;background-color:#WRITERCOLOR; color:#TEXTCOLOR;\" |'''Writer:''' AUTHOR" + "\n" +
            "|-" + "\n" +
            "| colspan=\"2\" |[[File:HEADERFILE|660px|link=|center]]" + "\n" +
            "|-" + "\n" +
            "! colspan=\"2\" style=\"text-align:center;background-color:#LOCATIONCOLOR; color:#TEXTCOLOR;\" |'''Location: SETTING'''\n";
            var dialogueRender =
            "|-" + "\n" + "|[[File:FILENAME|x200px|link=|center]]" + "\n" + "|" + "\n";
            var footer = "|-" + "\n" +
            "! colspan=\"2\" style=\"text-align:center;background-color:#BOTTOMCOLOR;color:#TEXTCOLOR;\" |'''Translation: [TLER] '''" +
            "\n" +
            "|}";

            var location = $('input[name=location]').val();
            var author = $('select[name=author] option:selected').text();
            var translator = $('input[name=translator]').val().trim();
            var tlLink = $('input[name=tlLink]').val().trim();

            if($('input[name=tlLocation]:checked').val()=='wiki'){
                translator = "[User:" + translator + "|" + translator + "]";
            }
            else if($('input[name=tlLocation]:checked').val()=='external'){
                translator = tlLink + " " + translator;
            }

            var writerCol = $('input[name=writerCol]').val().replace(/#/g, "");
            var locationCol = $("input[name=locationCol]").val().replace(/#/g, "");
            var bottomCol = $('input[name=bottomCol]').val().replace(/#/g, "");
            var textCol = $('input[name=textCol]').val().replace(/#/g, "");

            var tlNotes = $('#tlArea').val().trim();
            tlNotes = tlNotes.split(/\n/);
            var tlDict = {};
            tlNotes.forEach(function(exp){
                tlDict[exp.slice(0,exp.indexOf("]")+1)] = exp.trim();
            });

            console.log(tlDict);

            var output;

            header = header.replace("SETTING", location.trim());
            header = header.replace("AUTHOR", author);
            footer = footer.replace("TLER", translator);
            header = header.replace("WRITERCOLOR", writerCol);
            header = header.replace("LOCATIONCOLOR", locationCol);
            footer = footer.replace("BOTTOMCOLOR", bottomCol);
            header = header.replace(/TEXTCOLOR/g, textCol);
            footer = footer.replace("TEXTCOLOR", textCol);

            var input = $('#inputArea').val().trim();
            input = input.split(/\n/);
            var currentName = "";
            var tlExp = /\[\d\]/;
            var tlToInput = "";
            output = header;
            input.forEach(function(exp){
            	if(exp != ""){
					var current = exp.slice(0,exp.indexOf(":"));
					exp = exp.slice(exp.indexOf(":") + 1).trim();
					if(current == currentName){
						output += exp + "\n\n";
					}
					else if(current != currentName){
						currentName = current;
						var renderFile = dialogueRender;
						var id = "#" + current[0].toUpperCase() + current.slice(1,current.length);
						if(tlToInput!=""){
							console.log(tlToInput)
							output += tlToInput;
							tlToInput = "";
						}
						output += renderFile.replace("FILENAME", $(id).val().trim());
						// output += dialogueRender;
						output += exp + "\n\n";
					}
					var tlMarkers = exp.match(tlExp);
					//console.log(tlMarkers);
					if(tlMarkers!=null){
						var note = "\'\'" + tlDict[tlMarkers[0]] + "\'\'" + "\n\n";
						tlToInput = note;
					}
				}
            });
            output += footer;

            $('#outputArea').val(output);
            return false;
        }
        </script>

    </body>
    </html>
